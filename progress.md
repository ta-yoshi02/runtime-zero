Original prompt: Vite + Phaser で 2D横スクロールアクション「Runtime: Zero」を段階実装。今回は最初の縦切りとして、Viteデフォルト画面を Phaser 起動へ置換し、Title → Stage Select → Stage1 → Result の遷移、可変ジャンプ/ジャンプバッファ/コヨーテを最初から実装し、拡張しやすい構成にする。仮アセットで進める。

## 2026-02-06
- セッション開始。skills: develop-web-game / playwright を適用。imagegen は今回未使用（仮図形アセットのため）。
- Phaser最小縦切りを実装: Scene分割（Boot/Title/StageSelect/StagePlay/Result）、session store、stage data、入力システム、プレイヤー制御を追加。
- 操作感（可変ジャンプ/ジャンプバッファ/コヨーテ）を `PlayerController` に実装。
- Pauseメニュー（Resume/Restart/Exit）と Result 戻り導線を追加。
- `window.render_game_to_text` を各Sceneで公開。
- `vite.config.ts` を追加し、`VITE_BASE_PATH` または `VITE_USE_GH_PAGES_BASE=1` / `GITHUB_ACTIONS=true` で `base='/runtime-zero/'` に切替可能化。
- 検証: `npm run build` 成功、`VITE_USE_GH_PAGES_BASE=1 npm run build` 成功（dist内の参照が `/runtime-zero/` になることを確認）。
- 制約: Playwright導入/実行はネットワーク到達不可（ENOTFOUND registry.npmjs.org）で未実施。dev server は 127.0.0.1:5173 で 200 応答を確認。
- Main Menu/Credits/Tuning Scene を追加し、画面フローを Title -> Main Menu -> Stage Select -> Ingame -> Result に拡張。
- Stage Select から Options(Tuning) 遷移を追加（O/F1）。
- Tuning UI を実装：スライダー調整（キー/マウス対応）+ `localStorage` 永続化（`runtime-zero:tuning-overrides:v1`）。
- プレイヤー操作を拡張：Run（Shift/X）、Wall Jump、Slide（Run+Down）、Ground Pound（空中Down）。
- Mirror時の左右入力反転を追加（ステージ反転と整合）。
- カメラ先読みを通常/ダッシュで分離し、Tuning値を反映。
- 検証: `npm run build` 成功、`VITE_USE_GH_PAGES_BASE=1 npm run build` 成功。
- 保留: 自動プレイ検証（Playwright導入不能のため）、敵/アイテム/変身/攻撃/CI/README 等。
- 再開後の現状確認を実施。未コミット差分は保持されており、build/test は現時点で成功。
- skills確認: develop-web-game / playwright / imagegen の SKILL.md を読み、適用順を明確化。imagegen は現段階で画像生成タスク未着手。
- develop-web-game要件補完として `window.advanceTime(ms)` を `src/game/index.ts` に追加。
- `vite.config.ts` の base 切替を強化（`GITHUB_PAGES=true` でも `/runtime-zero/` を選択可能）。
- 公開運用ファイルを追加: `README.md`, `LICENSE`(MIT), `docs/stage-design.md`, `.github/workflows/pages.yml`。
- Playwright実プレイは依然としてネットワーク制限で未実施（`registry.npmjs.org` ENOTFOUND）。
- CI workflow更新: `actions/configure-pages@v5` を追加し、main push時の Pages artifact/deploy を安定化。
- 検証ループ: `npm run build`, `npm test`, `VITE_USE_GH_PAGES_BASE=1 npm run build` を再実行し全て成功。
- 不具合修正: クリア後Result遷移時に `StagePlay.finishRun()` が `physics.world.pause()` を残し、次回ステージ開始後に操作してもキャラが動かない症状を確認。
- 対応: `StagePlay.create()` 先頭で `physics.world.resume()`、`finishRun()` から pause を除去、さらに `ResultScene.create()` でも `physics.world.resume()` を実施して復帰を保証。
- Result画面遷移の再不具合に対処: `ResultScene` の入力を `GameInput + JustDown` のみから、キーボード状態リセット (`keyboard.resetKeys`) と生 `keydown` ハンドラ併用に変更。
- Enter/NumpadEnter/Space -> Stage Select, R -> Retry, T/Escape -> Main Menu を明示的に処理し、遷移ロックで多重startを防止。
- 追加対処: Result画面に `window.addEventListener('keydown')` フォールバックを追加し、Phaser keyboard plugin 側が不発でも遷移できるようにした。
- さらにクリック遷移ボタン（Stage Select / Retry / Main Menu）をResult下部に追加し、キーボード非依存でも復帰可能にした。
- 最終フォールバック追加: Result画面で Phaser input が完全停止しても遷移できるよう、`#app` 直下に DOM ボタン（Stage Select/Retry/Main Menu）をマウント。
- さらに12秒で Stage Select へ自動遷移するタイムアウトを追加し、Resultでの詰みを防止。
- Result遷移を `transitionTo()` に一本化し、`scene.start()` 後300msで target scene が active でない場合は `Title` へ自動復旧する watchdog を追加。
- 目的: Resultからの遷移時に次シーン起動失敗でフリーズフレームが残るケースを自動回復。
- 追加修正: Result shutdown 時に watchdog を消してしまい、遷移失敗時の回復が走らない不具合を修正。
- watchdog判定を `isActive && isVisible && !isSleeping` に強化し、未起動時は Title へ確実復帰するようにした。
- 遷移失敗フェイルセーフを追加: `bootIntent` (sessionStorage) を導入し、Resultからの遷移失敗時は目的sceneを保存して `window.location.reload()`。
- BootScene で bootIntent を消費し、stage/difficulty/mirror を復元して目的sceneへ直接復帰。
- SessionStore に `setDifficulty` / `setMirror` を追加して復元経路を明示。
- ユーザー要望に合わせて Result画面の重複UIを撤去。追加していた in-canvas ボタン群と DOM フォールバックボタンを削除し、表示は元のキーヒントのみへ戻した。
- 遷移安定化の中核（window keydown fallback + watchdog/reload fallback）は維持。
- 公開不具合調査: `https://ta-yoshi02.github.io/runtime-zero/` は `dist` ではなくリポジトリ直下 `index.html` と `src/main.ts` を配信していることを確認（GitHub Pages側の `pages-build-deployment`/Jekyll 経路）。
- `gh run` 調査で `.github/workflows/pages.yml` の `CI and Pages` は `actions/configure-pages@v5` で「Pages site not found」で失敗しており、その結果として `pages-build-deployment` が代替実行される状態を確認。
- 対応: `.github/workflows/pages.yml` の `actions/configure-pages@v5` に `with: enablement: true` を追加し、Pages未初期化時でも workflow でサイト初期化して `dist` デプロイ経路へ復帰できるようにした。

## 2026-02-08
- ユーザー要望対応: `README.md` 冒頭に「GPT5.3で作成したお遊びプロトタイプ」である旨を追記。
- 奈落落下判定の不具合を修正: `StagePlayScene.setupWorld()` で `physics.world.setBoundsCollision(true, true, true, false)` を設定し、ワールド下端でプレイヤーが止まらないようにした（`y > stage.height + 100` の `null_pointer` 判定へ到達可能化）。
- 検証: `npm run build` 成功、`npm test` 成功。
- develop-web-game スキルの Playwright クライアント実行を試行したが、環境に `playwright` パッケージが無く `ERR_MODULE_NOT_FOUND` で実行不可。
- TODO: Playwright を利用可能にした上で、Title -> Stage Select -> Stage1 の実プレイループで奈落落下時の `null_pointer` 結果を画面/`render_game_to_text` で確認する。
- ユーザー要望対応(奈落復帰仕様): `StagePlayScene.handleNullPointerFall()` をバックアップ消費/ゲームオーバー経路から切り離し、奈落落下時は常に復帰処理へ変更。
- ユーザー要望対応(リスキル防止): 復帰座標をチェックポイント中心固定から「近傍の静的平台上への安全スナップ」に変更。
  - `staticPlatformRects` を保持して、候補Xを左右に探索し、床上(`platform.y - 8`)に再配置。
  - チェックポイントが空中や穴上でも、近くの床に補正して即落下を回避。
  - チェックポイントで安全点が見つからない場合は、ステージ開始地点の安全点へフォールバック。
- 検証: `npm run build` 成功、`npm test` 成功。
- ユーザー指示に合わせて復帰仕様を再調整。
  - チェックポイント未到達時: スタート地点そのものではなく `START_RESPAWN_DROP_Y` 分だけ上から復帰して落下させるよう変更。
  - チェックポイント到達後: 復帰座標をチェックポイント中心固定へ戻し、代わりにチェックポイント生成時に静的平台へ自動スナップして「必ず床上」に配置するよう変更。
  - これにより、セーブ地点の床抜け復帰をデータ個別修正なしで回避。
- 検証: `npm run build` 成功、`npm test` 成功。
- UI不具合修正: Pauseオーバーレイ配下オブジェクトのdepthをローカル順に戻し、コンテナ自体を `setDepth(100)` に変更。Pause中にゲームオブジェクトが上に描画される問題を解消。
- チェックポイント不具合修正: プラットフォーム補正時のY基準を `platform.y - checkpoint.height` に変更し、チェックポイントを床上に配置。
- 復帰位置補正: チェックポイント復帰時のYを `checkpoint.y + checkpoint.height - 8` に変更し、床上復帰と整合。
- 検証: `npm run build` / `npm test` 成功。
- 追加修正: チェックポイント復帰Yを固定オフセット計算から、プレイヤーの実ボディ寸法(`displayHeight/origin/body.offset/body.height`)ベース計算へ変更。
  - `getPlayerSpawnYFromGround(groundY)` を追加し、床面Yから「足元が床上1px」に来るスプライトYを算出。
  - これにより、チェックポイント直下への埋まり復帰（リスキル）を解消。
- 検証: `npm run build` / `npm test` 成功。
- 追加調整: チェックポイント復帰位置をさらに上げるため `CHECKPOINT_RESPAWN_CLEARANCE_Y=12` を導入し、地面算出位置から上方向にオフセットして復帰させるよう変更。
- 検証: `npm run build` / `npm test` 成功。
- Stage4の赤い四角(弾)が停止して見える問題に対処。
  - `ShotRuntime` に速度保持を追加し、`updateShots()` 内で毎フレーム `enforceShotVelocity()` を適用して弾の速度を再保証。
  - `player-shot`/`enemy-shot` 生成時に `velocityX/velocityY` を保存。
  - `shotSpeed` が不正値でも最低速度を確保するフォールバックを追加。
- 目的: 弾がその場に留まる現象を防ぎ、進行方向へ安定して飛ぶようにする。
- 検証: `npm run build` / `npm test` 成功。
- 被弾時の「主人公が消えたように見える」問題へ対処。
  - `respawnAtCheckpoint()` で復帰座標へ移動直後に `snapCameraToPosition()` を実行し、カメラを即時スナップするよう変更。
  - これにより、RAW状態被弾で遠距離リスポーンしても画面外に取り残されず、挙動が明確になる。
- 検証: `npm run build` / `npm test` 成功。
- 追加不具合対応（ユーザー報告）:
  - 被弾後に主人公が消えて操作不能に見える件: `respawnAtCheckpoint()` で `player.sprite` を `setActive(true)/setVisible(true)/setAlpha(1)` で明示復帰し、復帰直後の接地状態スナップショットも更新。
  - Stage終了時にResult遷移が失敗するとStage側が `stageFinished=true` のまま固まる件に備え、`finishRun()` にResult起動ウォッチドッグを追加。起動失敗時は `MainMenu` へフォールバック。
  - Result画面でEsc遷移後に無反応化する件: `window` グローバル keydown フォールバックと `reload` 経路を撤去し、Resultシーン内タイマーによる遷移監視 + MainMenuフォールバックへ簡素化。
  - Stage4終盤の紫chaserが床に阻まれる件: `s4-enemy-4` の `y` を `530 -> 500` に調整。
- 検証: `npm run build` / `npm test` 成功。
- Result入力不安定対策を追加。
  - ResultSceneの入力を簡素化（シーン内キーのみ: Enter/NumpadEnter/Space/R/T/Esc）し、transition中に詰まった場合は800msでMainMenuへ強制フォールバック。
  - 目的: T/Esc後にEnterや十字キーが順次効かなくなる遷移ロック状態を解消。
- 敵弾被弾後にStageで主人公が消えたままになる対策を追加。
  - StagePlayにResult遷移待ち監視を追加し、Resultが起動しないまま900ms経過した場合はMainMenuへ復帰。
  - 目的: Backups=0被弾時のResult遷移失敗で stageFinished のまま入力停止するケースを回避。
- 検証: `npm run build` / `npm test` 成功。
- Console例外対応: `StageSelectScene.refreshTexts()` で破棄済みTextへ `setColor` が走るケースを修正。
  - `create()` 冒頭と `SHUTDOWN` で `stageRows` をクリア。
  - `refreshTexts()` で `!row.active || row.scene !== this` を除外。
  - これにより `Frame2.updateUVs ... drawImage` 例外を回避。
- 被弾後フリーズ対策をさらに強化。
  - `stageFinishedAtMs` を導入し、Resultが起動していない状態で `stageFinished` が1.2秒以上続いたらMainMenuへ強制復帰。
  - 既存の `awaitingResultTransition` 監視と組み合わせて、入力停止の取りこぼしを減らす。
- 検証: `npm run build` / `npm test` 成功。
- 敵弾被弾で操作不能化する不具合への最終対策として、`useBackupAndRespawn('glitch')` の `backups=0` 時動作を変更。
  - 以前: `finishRun(false, 'glitch')`（Result遷移経路）
  - 変更後: `activeCheckpoint = null` にして `respawnAtCheckpoint()`（ステージ開始地点リスポーン）
- これで敵/敵弾被弾はバックアップ残量に関わらず「チェックポイント or スタート復帰」に統一され、被弾後に停止する経路を回避。
- 検証: `npm run build` / `npm test` 成功。
- 敵弾ヒット時の「主人公が消えて操作不能」不具合を原因解析。
  - 原因: Projectileの `overlap/collider` コールバックが引数順を前提にしており、順序が入れ替わった場合に弾ではなくプレイヤー/敵を `destroy()` し得る実装だった。
  - 対応: `StagePlayScene.createProjectileSystems()` を順序非依存化し、`ShotRuntime`/`EnemyRuntime` のMap所属判定で対象を解決してから処理するよう変更。
  - 追加: `extractArcadeGameObject()` を導入し、コールバック引数が `Body` でも `gameObject` へ正規化して判定可能にした。
- 検証: `npm run build` 成功、`npm test` 成功。
- develop-web-game スキル要件の Playwright クライアント実行は、環境に `playwright` が無いため `ERR_MODULE_NOT_FOUND`（`Cannot find package 'playwright'`）で未実施。
- ユーザー報告対応: 被弾時にチェックポイントが反映されず常にスタート復帰する不具合を修正。
  - 原因: `useBackupAndRespawn('glitch')` の `backups=0` 分岐で `activeCheckpoint = null` を強制していた。
  - 対応: 強制クリアを削除し、`respawnAtCheckpoint()` へ統一。結果として「チェックポイントがあればそこの少し上、なければスタート上空」へ復帰。
- 検証: `npm run build` / `npm test` 成功。
- ユーザー要望対応(水中操作): `GameInput` に `isUpHeld()` を追加し、`StagePlayScene.updateEnvironment()` で「水中かつ↑保持中」に上向き推進 (`WATER_SWIM_ASCENT_FORCE`) を加えるよう変更。
  - 通常地形でのジャンプ仕様（単発ジャンプ）は `PlayerController.tryConsumeJump()` 側を変更せず維持。
- 検証: `npm run build` / `npm test` 成功。
- develop-web-game スキル要件の Playwright クライアント実行を再試行したが、引き続き `playwright` 未導入により `ERR_MODULE_NOT_FOUND` で実行不可。
